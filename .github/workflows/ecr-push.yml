name: Build & Push to ECR & Update ECS

on:
  push:
    branches: [ main ]
    paths:
      - "apps/**"
      - ".github/workflows/ecr-push.yml"

  workflow_dispatch:
    inputs:
      environment:
        description: "Environment"
        required: true
        type: choice
        options: [ dev, qa, stage ]
      service:
        description: "Service"
        required: true
        type: choice
        options: [ frontend, backend, both ]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  PROJECT_NAME: conde-nast

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Resolve inputs
        id: vars
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
            SERVICE="${{ github.event.inputs.service }}"
          else
            ENV="dev"
            SERVICE="both"
          fi

          echo "env=$ENV" >> $GITHUB_OUTPUT
          echo "service=$SERVICE" >> $GITHUB_OUTPUT

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      # ---------- BUILD & PUSH ----------
      - name: Build & Push Frontend
        if: steps.vars.outputs.service == 'frontend' || steps.vars.outputs.service == 'both'
        id: fe
        run: |
          IMAGE="${{ env.PROJECT_NAME }}-frontend-${{ steps.vars.outputs.env }}"
          TAG="${{ github.sha }}"
          docker build -t $IMAGE:$TAG ./apps/frontend
          docker tag $IMAGE:$TAG ${{ steps.login-ecr.outputs.registry }}/$IMAGE:$TAG
          docker push ${{ steps.login-ecr.outputs.registry }}/$IMAGE:$TAG
          echo "image=${{ steps.login-ecr.outputs.registry }}/$IMAGE:$TAG" >> $GITHUB_OUTPUT

      - name: Build & Push Backend
        if: steps.vars.outputs.service == 'backend' || steps.vars.outputs.service == 'both'
        id: be
        run: |
          IMAGE="${{ env.PROJECT_NAME }}-backend-${{ steps.vars.outputs.env }}"
          TAG="${{ github.sha }}"
          docker build -t $IMAGE:$TAG ./apps/backend
          docker tag $IMAGE:$TAG ${{ steps.login-ecr.outputs.registry }}/$IMAGE:$TAG
          docker push ${{ steps.login-ecr.outputs.registry }}/$IMAGE:$TAG
          echo "image=${{ steps.login-ecr.outputs.registry }}/$IMAGE:$TAG" >> $GITHUB_OUTPUT

      # ---------- DEPLOY ----------
      - name: Update ECS
        run: |
          set -euo pipefail

          ENV="${{ steps.vars.outputs.env }}"
          SERVICE="${{ steps.vars.outputs.service }}"

          FRONTEND_IMAGE="${{ steps.fe.outputs.image || '' }}"
          BACKEND_IMAGE="${{ steps.be.outputs.image || '' }}"

          FRONTEND_CLUSTER="conde-nast-fe-${ENV}"
          BACKEND_CLUSTER="conde-nast-be-${ENV}"

          FRONTEND_SERVICE="fe-service"
          BACKEND_SERVICE="be-service"

          FRONTEND_TASK="conde-nast-fe-service"
          BACKEND_TASK="conde-nast-be-service"

          register_task_definition () {
            TASK_FAMILY=$1
            CONTAINER_NAME=$2
            IMAGE=$3

            TASK_DEF=$(aws ecs describe-task-definition \
              --task-definition $TASK_FAMILY \
              --query taskDefinition)

            NEW_DEF=$(echo "$TASK_DEF" | jq --arg IMG "$IMAGE" \
              '.containerDefinitions |= map(
                if .name=="'"$CONTAINER_NAME"'" then .image=$IMG else . end
              )
              | del(.taskDefinitionArn,.revision,.status,.requiresAttributes,.compatibilities,.registeredAt,.registeredBy)'
            )

            aws ecs register-task-definition \
              --cli-input-json "$NEW_DEF" \
              --query taskDefinition.taskDefinitionArn \
              --output text
          }

          if [[ "$SERVICE" == "frontend" || "$SERVICE" == "both" ]]; then
            TD=$(register_task_definition "$FRONTEND_TASK" "frontend" "$FRONTEND_IMAGE")
            aws ecs update-service \
              --cluster $FRONTEND_CLUSTER \
              --service $FRONTEND_SERVICE \
              --task-definition $TD
          fi

          if [[ "$SERVICE" == "backend" || "$SERVICE" == "both" ]]; then
            TD=$(register_task_definition "$BACKEND_TASK" "backend" "$BACKEND_IMAGE")
            aws ecs update-service \
              --cluster $BACKEND_CLUSTER \
              --service $BACKEND_SERVICE \
              --task-definition $TD
          fi

      - name: Wait for ECS stability
        run: |
          aws ecs wait services-stable \
            --cluster conde-nast-fe-${{ steps.vars.outputs.env }} \
            --services fe-service || true
          aws ecs wait services-stable \
            --cluster conde-nast-be-${{ steps.vars.outputs.env }} \
            --services be-service || true
